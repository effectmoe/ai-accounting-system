# Dashboard Metrics Investigation Report

## 調査日時: 2025-01-23

## 問題の概要
AAM Accountingシステムのダッシュボードページ（`/`）において、以下の2つのセクションが実際のデータではなく、静的なダミーデータを表示している：

1. **月次進捗サマリー** - 売上高、処理済み書類、アクティブ顧客数
2. **最近のアクティビティ** - 作成ログ（請求書、見積書、新規顧客）

## 調査結果

### 1. 現在の実装状況

#### フロントエンド (`app/page.tsx`)
- **静的データの使用**:
  - 売上高: `¥1,234,567` (ハードコード、213行目)
  - 処理済み書類: `156件` (ハードコード、232行目)
  - アクティブ顧客: `48社` (ハードコード、250行目)
  - 最近のアクティビティ: 静的配列 (143-147行目)

- **API呼び出しの欠如**:
  - データ取得のための`useEffect`やAPI呼び出しが一切実装されていない
  - すべてのデータが静的に定義されている

#### バックエンド API
- **既存のAPI**:
  - `/api/dashboard/profit-stats` - 利益統計データを提供
    - 売上データ（請求書から集計）
    - 仕入データ（発注書から集計）
    - 案件統計
    - 商品別・顧客別利益分析

- **不足しているAPI**:
  - 一般的なダッシュボードメトリクス用API（処理済み書類数、アクティブ顧客数）
  - 最近のアクティビティ/活動ログ用API

### 2. 根本原因

1. **フロントエンドの問題**:
   - ダッシュボードコンポーネントがAPIと統合されていない
   - データフェッチングロジックが実装されていない
   - ローディング状態やエラーハンドリングが考慮されていない

2. **バックエンドの問題**:
   - 包括的なダッシュボードメトリクスAPIが不足
   - アクティビティログの中央集約システムが存在しない
   - 各エンティティ（請求書、見積書、顧客）の作成・更新イベントが記録されていない

3. **データ構造の問題**:
   - アクティビティログ用のコレクション/テーブルが定義されていない
   - 監査ログやイベントトラッキングの仕組みが不完全

### 3. 影響範囲

- ユーザーは実際のビジネス状況を把握できない
- リアルタイムの進捗管理ができない
- 最近の活動履歴が確認できない

### 4. 推奨される修正手順

#### Phase 1: バックエンドの改善
1. **アクティビティログコレクションの作成**:
   ```typescript
   interface ActivityLog {
     _id: ObjectId;
     type: 'invoice_created' | 'quote_created' | 'customer_added' | ...;
     entityType: 'invoice' | 'quote' | 'customer' | ...;
     entityId: ObjectId;
     description: string;
     userId?: ObjectId;
     metadata?: Record<string, any>;
     createdAt: Date;
   }
   ```

2. **ダッシュボードメトリクスAPIの作成**:
   - `/api/dashboard/metrics` - 総合的なメトリクスを返す
   - `/api/dashboard/activities` - 最近のアクティビティを返す

3. **既存のサービスにアクティビティログ記録を追加**:
   - 請求書作成時にログ記録
   - 見積書作成時にログ記録
   - 顧客追加時にログ記録

#### Phase 2: フロントエンドの統合
1. **データフェッチングの実装**:
   ```typescript
   const [metrics, setMetrics] = useState(null);
   const [activities, setActivities] = useState([]);
   const [loading, setLoading] = useState(true);

   useEffect(() => {
     fetchDashboardData();
   }, []);
   ```

2. **リアルタイム更新の検討**:
   - WebSocketまたはポーリングによる自動更新
   - ローディング状態の表示
   - エラーハンドリング

#### Phase 3: データの整合性確保
1. **既存データの移行**:
   - 過去の請求書、見積書、顧客データからアクティビティログを生成

2. **テストとバリデーション**:
   - APIエンドポイントのテスト
   - フロントエンドの統合テスト
   - パフォーマンステスト

### 5. 技術的な詳細

#### 既存のコードパス
- ダッシュボード: `/app/page.tsx`
- 利益統計API: `/app/api/dashboard/profit-stats/route.ts`
- 型定義: `/types/collections.ts`

#### MongoDBコレクション
- `invoices` - 請求書データ
- `quotes` - 見積書データ
- `customers` - 顧客データ
- `deals` - 案件データ（アクティビティ履歴を含む）

### 6. 緊急度と優先順位

**高優先度**:
- ダッシュボードメトリクスAPIの作成
- フロントエンドのAPI統合

**中優先度**:
- アクティビティログシステムの実装
- リアルタイム更新機能

**低優先度**:
- 高度な分析機能
- カスタマイズ可能なダッシュボード

### 7. 推定作業時間

- バックエンドAPI開発: 8-12時間
- フロントエンド統合: 4-6時間
- テストとデバッグ: 4-6時間
- **合計: 16-24時間**

## 結論

ダッシュボードが静的データを表示している主な原因は、フロントエンドとバックエンドの統合が完成していないことです。既存の`profit-stats` APIは良い出発点となりますが、包括的なダッシュボード機能を実現するには、追加のAPIエンドポイントとフロントエンドの実装が必要です。