# GAS OCR処理のトラブルシューティング手順

## 問題の概要
- PDFがGoogle Driveにアップロードされる ✅
- GASのdoPost関数が実行される ✅
- しかし、OCR処理が実行されていない、またはログが出力されていない ❌

## 修正版コードの適用手順

### 1. GASエディタを開く
1. https://script.google.com にアクセス
2. 「AI会計OCR-Complete」プロジェクトを開く

### 2. 修正版コードをコピー
1. 現在のコードをバックアップ（念のため）
2. `/gas-src/complete-ocr-system-fixed.gs` の内容を全てコピー
3. GASエディタに貼り付けて保存

### 3. デバッグ関数を実行

#### A. API設定の確認
```
関数: checkApiSettings
実行してログを確認
```

期待される出力：
- Drive API v2: ✅ 正常
- 監視フォルダ: ✅ [フォルダ名]
- アーカイブフォルダ: ✅ [フォルダ名]

#### B. 最新ファイルの確認
```
関数: checkRecentFiles
実行してログを確認
```

PDFファイルが表示されるはずです。

#### C. Supabase接続テスト
```
関数: testSupabaseConnection
実行してログを確認
```

成功すれば、Supabaseにテストデータが保存されます。

#### D. 手動OCRテスト
```
関数: manualOcrTest
実行してログを確認
```

詳細なログが表示され、エラーの原因が特定できます。

### 4. Webアプリの再デプロイ

修正版コードを適用後：

1. 「デプロイ」→「デプロイを管理」
2. 現在のデプロイの「編集」をクリック
3. 「バージョン」で「新しいバージョン」を選択
4. 説明に「ログ修正版」と入力
5. 「デプロイ」をクリック

### 5. 実際のファイルアップロードテスト

1. Google Driveの監視フォルダに新しいPDFをアップロード
2. GASの実行ログを確認：
   - 「実行数」タブを開く
   - 最新の`doPost`実行を選択
   - 「ログを表示」をクリック

## エラー別の対処法

### "Drive is not defined"
→ Drive API v2が追加されていない
1. 「サービス」→「Drive API」を追加
2. バージョン「v2」を選択

### "TypeError: Cannot read property 'items' of undefined"  
→ フォルダIDが間違っている
1. Google DriveでフォルダのURLを確認
2. IDを正しく設定

### "401 Unauthorized" (Supabase)
→ 認証キーが間違っている
1. Supabaseダッシュボードでanon keyを再確認
2. GASスクリプトの`SUPABASE_ANON_KEY`を更新

### ログに何も表示されない
→ プッシュ通知が正しく設定されていない可能性
1. Webアプリのアクセス権限を確認（「全員」になっているか）
2. Drive APIのプッシュ通知チャンネルを再設定

## 確認すべきポイント

1. **フォルダの権限**
   - 監視フォルダとアーカイブフォルダへのアクセス権限があるか

2. **Drive API v2の有効化**
   - サービスに追加されているか
   - 正しいバージョン（v2）か

3. **Supabaseの設定**
   - URL、認証キーが正しいか
   - `ocr_results`テーブルが存在するか

4. **プッシュ通知の設定**
   - Webアプリが公開されているか
   - アクセス権限が「全員」になっているか

## 次のアクション

上記の手順を実行後、ログの内容を確認してください。エラーメッセージが表示されれば、問題の原因が特定できます。