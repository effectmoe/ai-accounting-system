<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦‹ç©æ›¸å€¤å¼•ãæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h2 {
            color: #007bff;
            margin-top: 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .discount-button {
            background-color: #dc3545;
        }
        .discount-button:hover {
            background-color: #c82333;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .item-display {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .discount-item {
            background-color: #fee;
            border-color: #fcc;
        }
        .discount-text {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª è¦‹ç©æ›¸å€¤å¼•ãæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-section">
            <h2>1. å€¤å¼•ãé …ç›®ã®è¿½åŠ ãƒ†ã‚¹ãƒˆ</h2>
            <p>é€šå¸¸ã®å•†å“é …ç›®ã¨å€¤å¼•ãé …ç›®ã‚’å«ã‚€è¦‹ç©æ›¸ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
            <button onclick="testCreateQuoteWithDiscount()">è¦‹ç©æ›¸ä½œæˆãƒ†ã‚¹ãƒˆ</button>
            <div id="create-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. å€¤å¼•ãé …ç›®ã®è¡¨ç¤ºãƒ†ã‚¹ãƒˆ</h2>
            <p>ä½œæˆã—ãŸè¦‹ç©æ›¸ã‚’å–å¾—ã—ã¦ã€å€¤å¼•ãé …ç›®ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚</p>
            <input type="text" id="quote-id" placeholder="è¦‹ç©æ›¸IDã‚’å…¥åŠ›" style="padding: 8px; width: 300px;">
            <button onclick="testDisplayQuote()">è¦‹ç©æ›¸è¡¨ç¤ºãƒ†ã‚¹ãƒˆ</button>
            <div id="display-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. åˆè¨ˆé‡‘é¡è¨ˆç®—ãƒ†ã‚¹ãƒˆ</h2>
            <p>å€¤å¼•ãã‚’å«ã‚€åˆè¨ˆé‡‘é¡ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚</p>
            <button onclick="testCalculation()">è¨ˆç®—ãƒ†ã‚¹ãƒˆ</button>
            <div id="calc-result" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api'; // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨
        // const API_BASE_URL = 'https://accounting-automation.vercel.app/api'; // æœ¬ç•ªç’°å¢ƒç”¨

        async function testCreateQuoteWithDiscount() {
            const resultDiv = document.getElementById('create-result');
            resultDiv.textContent = 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';
            
            try {
                // ãƒ†ã‚¹ãƒˆç”¨ã®è¦‹ç©æ›¸ãƒ‡ãƒ¼ã‚¿
                const quoteData = {
                    customerId: '66859daa37ad93b1be973d6f', // ãƒ†ã‚¹ãƒˆç”¨é¡§å®¢IDï¼ˆå®Ÿéš›ã®IDã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
                    title: 'å€¤å¼•ããƒ†ã‚¹ãƒˆè¦‹ç©æ›¸',
                    quoteDate: new Date().toISOString(),
                    validityDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30æ—¥å¾Œ
                    items: [
                        {
                            itemName: 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆåˆ¶ä½œ',
                            description: 'ä¼æ¥­ã‚µã‚¤ãƒˆåˆ¶ä½œä¸€å¼',
                            itemType: 'product',
                            quantity: 1,
                            unitPrice: 500000,
                            amount: 500000,
                            taxRate: 10,
                            taxAmount: 50000
                        },
                        {
                            itemName: 'ä¿å®ˆã‚µãƒãƒ¼ãƒˆï¼ˆå¹´é–“ï¼‰',
                            description: 'å¹´é–“ä¿å®ˆã‚µãƒãƒ¼ãƒˆå¥‘ç´„',
                            itemType: 'product',
                            quantity: 1,
                            unitPrice: 120000,
                            amount: 120000,
                            taxRate: 10,
                            taxAmount: 12000
                        },
                        {
                            itemName: 'æ–°è¦é¡§å®¢å‰²å¼•',
                            description: 'åˆå›é™å®šç‰¹åˆ¥å‰²å¼•',
                            itemType: 'discount',
                            discountReason: 'æ–°è¦é¡§å®¢ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³',
                            quantity: 1,
                            unitPrice: -50000,
                            amount: -50000,
                            taxRate: 10,
                            taxAmount: -5000
                        }
                    ],
                    notes: 'ã“ã®è¦‹ç©æ›¸ã¯å€¤å¼•ãæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆç”¨ã§ã™ã€‚'
                };

                const response = await fetch(`${API_BASE_URL}/quotes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(quoteData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `âœ… è¦‹ç©æ›¸ä½œæˆæˆåŠŸï¼\n\n` +
                    `è¦‹ç©æ›¸ID: ${result._id}\n` +
                    `è¦‹ç©æ›¸ç•ªå·: ${result.quoteNumber}\n` +
                    `å°è¨ˆ: Â¥${result.subtotal?.toLocaleString()}\n` +
                    `ç¨é¡: Â¥${result.taxAmount?.toLocaleString()}\n` +
                    `åˆè¨ˆ: Â¥${result.totalAmount?.toLocaleString()}\n\n` +
                    `è©³ç´°:\n${JSON.stringify(result, null, 2)}`;
                
                // IDã‚’è¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è‡ªå‹•å…¥åŠ›
                document.getElementById('quote-id').value = result._id;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        async function testDisplayQuote() {
            const resultDiv = document.getElementById('display-result');
            const quoteId = document.getElementById('quote-id').value;
            
            if (!quoteId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è¦‹ç©æ›¸IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }
            
            resultDiv.textContent = 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/quotes/${quoteId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const quote = await response.json();
                
                let itemsHtml = '';
                quote.items.forEach((item, index) => {
                    const isDiscount = item.itemType === 'discount';
                    itemsHtml += `
                        <div class="item-display ${isDiscount ? 'discount-item' : ''}">
                            <strong>${index + 1}. ${isDiscount ? 'ã€å€¤å¼•ãã€‘' : ''}${item.itemName}</strong>
                            ${item.description ? `<br>èª¬æ˜: ${item.description}` : ''}
                            ${item.discountReason ? `<br>ç†ç”±: ${item.discountReason}` : ''}
                            <br>æ•°é‡: ${item.quantity}
                            <br>å˜ä¾¡: <span class="${isDiscount ? 'discount-text' : ''}">Â¥${item.unitPrice?.toLocaleString()}</span>
                            <br>å°è¨ˆ: <span class="${isDiscount ? 'discount-text' : ''}">Â¥${item.amount?.toLocaleString()}</span>
                            <br>ç¨é¡: <span class="${isDiscount ? 'discount-text' : ''}">Â¥${item.taxAmount?.toLocaleString()}</span>
                        </div>
                    `;
                });
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `âœ… è¦‹ç©æ›¸å–å¾—æˆåŠŸï¼\n\n` +
                    `<strong>è¦‹ç©æ›¸ç•ªå·:</strong> ${quote.quoteNumber}\n` +
                    `<strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${quote.title || 'ç„¡é¡Œ'}\n\n` +
                    `<strong>é …ç›®ä¸€è¦§:</strong>\n${itemsHtml}\n` +
                    `<strong>åˆè¨ˆ:</strong>\n` +
                    `å°è¨ˆ: Â¥${quote.subtotal?.toLocaleString()}\n` +
                    `ç¨é¡: Â¥${quote.taxAmount?.toLocaleString()}\n` +
                    `ç·è¨ˆ: Â¥${quote.totalAmount?.toLocaleString()}`;
                    
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        function testCalculation() {
            const resultDiv = document.getElementById('calc-result');
            
            // ãƒ†ã‚¹ãƒˆç”¨ã®è¨ˆç®—
            const items = [
                { name: 'å•†å“A', amount: 100000, tax: 10000 },
                { name: 'å•†å“B', amount: 50000, tax: 5000 },
                { name: 'å€¤å¼•ã', amount: -20000, tax: -2000, isDiscount: true }
            ];
            
            let subtotal = 0;
            let taxTotal = 0;
            let detailText = '';
            
            items.forEach(item => {
                subtotal += item.amount;
                taxTotal += item.tax;
                detailText += `${item.name}: Â¥${item.amount.toLocaleString()} (ç¨: Â¥${item.tax.toLocaleString()})\n`;
            });
            
            const total = subtotal + taxTotal;
            
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `âœ… è¨ˆç®—ãƒ†ã‚¹ãƒˆçµæœ\n\n` +
                `<strong>æ˜ç´°:</strong>\n${detailText}\n` +
                `<strong>è¨ˆç®—çµæœ:</strong>\n` +
                `å°è¨ˆ: Â¥${subtotal.toLocaleString()}\n` +
                `ç¨é¡: Â¥${taxTotal.toLocaleString()}\n` +
                `åˆè¨ˆ: Â¥${total.toLocaleString()}\n\n` +
                `<strong>æ¤œè¨¼:</strong>\n` +
                `100,000 + 50,000 - 20,000 = ${subtotal.toLocaleString()} âœ“\n` +
                `10,000 + 5,000 - 2,000 = ${taxTotal.toLocaleString()} âœ“\n` +
                `${subtotal.toLocaleString()} + ${taxTotal.toLocaleString()} = ${total.toLocaleString()} âœ“`;
        }
    </script>
</body>
</html>