# AAM Accounting ダッシュボード修正レポート

## 修正日時
2025-01-26

## 問題の概要

ダッシュボードに表示されている以下の数値が誤っていました：

1. **総請求額**: ¥4,616,800（誤）→ ¥11,000（正）
2. **アクティブ顧客**: 58社（誤）→ 4社（正）

## 問題の原因

### 1. 総請求額の計算ロジックの問題

`app/api/dashboard/metrics/route.ts`で、売上（収益）の計算に以下の問題がありました：

- `invoices`コレクション（売上請求書）: 正しく集計 ✓
- `supplierQuotes`コレクション（仕入先見積書）: **誤って売上として加算** ✗

仕入先見積書は支出であるべきですが、売上として計算されていたため、総請求額が実際より大幅に多く表示されていました。

### 2. アクティブ顧客数の計算ロジックの問題

以下の問題がありました：

- `customers`コレクション（顧客）: 正しくカウント ✓
- `suppliers`コレクション（仕入先）: **誤って顧客としてカウント** ✗

顧客数の計算に仕入先数（51社）が含まれていたため、実際の顧客数（4社）より大幅に多く表示されていました。

## 実施した修正

### 1. 総請求額の計算修正

```typescript
// 修正前
totalRevenue += supplierQuoteRevenue; // 仕入先見積書を誤って加算

// 修正後
// supplierQuotesは支出なので除外（仕入先からの見積書は支出）
// purchaseInvoicesも支出なので除外（仕入先からの請求書は支出）
```

- 売上として計算するのは`invoices`と`quotes`（承認済み）のみに限定
- 仕入先関連のドキュメント（`supplierQuotes`、`purchaseInvoices`）は除外

### 2. アクティブ顧客数の計算修正

```typescript
// 修正前
activeCustomers += activeSupplierCount; // 仕入先を誤ってカウント

// 修正後
// 過去90日間に取引のあった顧客のみをカウント
// 仕入先（suppliers）は完全に除外
```

- 過去90日間の`invoices`と`quotes`から顧客IDを抽出
- 重複を除外するために`Set`を使用
- 仕入先は顧客数の計算から完全に除外

## 修正後の正しい値

- **総請求額**: ¥11,000（売上請求書の合計のみ）
- **処理済み書類**: 20件（変更なし）
- **保留中書類**: 1件（変更なし） 
- **アクティブ顧客**: 4社（顧客のみ、仕入先は除外）

## テスト方法

1. アプリケーションを起動
```bash
npm run dev
```

2. ブラウザでダッシュボードを確認
```
http://localhost:3000
```

3. APIエンドポイントを直接確認
```bash
curl http://localhost:3000/api/dashboard/metrics
```

## 今後の推奨事項

1. **売上と支出の明確な分離**
   - 売上系: `invoices`, `quotes`
   - 支出系: `supplierQuotes`, `purchaseInvoices`
   - ダッシュボードで売上と支出を別々に表示することを推奨

2. **顧客と仕入先の明確な区別**
   - 顧客数と仕入先数を別々に表示
   - 「取引先」として合計を表示する場合は、その旨を明記

3. **データ型の確認**
   - 一部の`totalAmount`フィールドがオブジェクトとして保存されている可能性
   - データ整合性の確認が必要

## 影響範囲

- `/api/dashboard/metrics` APIエンドポイント
- メインページ（`/`）のダッシュボード表示

他のページやAPIには影響ありません。