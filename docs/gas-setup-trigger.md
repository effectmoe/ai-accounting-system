# Google Apps Script 自動トリガー設定手順

## 概要
OCR処理を自動化するために、Google Apps Scriptに1分ごとのトリガーを設定します。これにより、Google Driveに新しいPDFや画像ファイルがアップロードされたら自動的にOCR処理が実行されます。

## 設定手順

### 1. Google Apps Scriptエディタを開く
1. [Google Apps Script](https://script.google.com)にアクセス
2. 作成済みの「AI会計OCR」プロジェクトを開く

### 2. トリガー設定関数を実行
1. エディタで`gas-ocr-webhook.gs`が開いていることを確認
2. 関数選択ドロップダウンから`setupTimeDrivenTrigger`を選択
3. 「実行」ボタンをクリック

### 3. 権限の承認
初回実行時は権限の承認が必要です：
1. 「承認が必要です」ダイアログが表示される
2. 「権限を確認」をクリック
3. Googleアカウントを選択
4. 「詳細」をクリック → 「AI会計OCR（安全ではないページ）に移動」をクリック
5. 必要な権限を確認して「許可」をクリック

### 4. トリガーの確認
1. 左側メニューの「トリガー」をクリック
2. 以下のトリガーが作成されていることを確認：
   - 関数：`checkNewFilesAndProcess`
   - イベントソース：時間主導型
   - タイプ：分ベースのタイマー
   - 間隔：1分ごと

## 動作確認

### テスト方法
1. Google Driveの指定フォルダ（`1dlWqaq_BX5wrcbn4P3LpSOmog2r_hi-9`）にPDFまたは画像ファイルをアップロード
2. 1分以内にOCR処理が自動実行される
3. Supabaseの`ocr_results`テーブルに結果が保存される
4. 書類一覧ページにリアルタイムで通知が表示される

### ログの確認
1. Apps Scriptエディタで「実行数」をクリック
2. 実行履歴からログを確認
3. エラーが発生している場合は詳細を確認

## トラブルシューティング

### トリガーが動作しない場合
1. **権限エラー**: トリガー設定時に権限を正しく承認したか確認
2. **フォルダID**: スクリプトプロパティの`FOLDER_ID`が正しいか確認
3. **API有効化**: Google Drive APIが有効になっているか確認

### OCR処理が失敗する場合
1. **Drive API v2**: サービスにDrive API v2が追加されているか確認
2. **Supabase接続**: URLとAPIキーが正しいか確認
3. **ファイル形式**: PDFまたは画像ファイル（JPG、PNG）のみ対応

### トリガーの削除方法
不要になった場合：
1. Apps Scriptエディタの「トリガー」を開く
2. 削除したいトリガーの右端の「︙」をクリック
3. 「トリガーを削除」を選択

## 注意事項
- 1分ごとのトリガーはGoogle Apps Scriptの無料枠で十分動作します
- 大量のファイルを一度に処理する場合は、実行時間制限（6分）に注意
- トリガーは1つのプロジェクトに対して20個まで設定可能

## 関連ファイル
- `/docs/gas-ocr-webhook.gs` - メインのOCR処理スクリプト
- `/app/documents/page.tsx` - リアルタイム通知を表示するフロントエンド