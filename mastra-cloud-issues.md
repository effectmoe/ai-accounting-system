# Mastra Cloud デプロイ問題分析

## 発生している問題

### 1. @mastra/cli パッケージが存在しない
- npm レジストリに `@mastra/cli` が登録されていない
- エラー: `404 Not Found - GET https://registry.npmjs.org/@mastra%2fcli`
- Mastra公式ドキュメントで言及されているが、実際には利用できない

### 2. React 型定義の競合
- `@types/react@18` と `@types/react-dom@19` の間でバージョン競合
- 多数の依存関係が異なるバージョンを要求している

### 3. ビルドプロセスの不明確さ
- Mastra Cloud が期待するビルド手順が不明
- `mastra build` コマンドが使えない
- カスタムビルドスクリプトでの対応が必要

### 4. デプロイ後の Readiness Probe エラー
- ヘルスチェックエンドポイントへのアクセスがタイムアウト
- サーバーが正しく起動していない可能性

## 試みた解決策

### 1. 依存関係の修正
✅ 完了:
- `@ai-sdk/anthropic`: ^0.0.72 → ^1.0.0
- `@googleapis/drive`: ^8.21.0 → ^8.0.0
- `@types/formidable`: ^3.4.6 → ^3.4.5
- `@upstash/redis`: ^1.37.0 → ^1.35.1
- `google-auth-library`: ^9.16.1 → ^9.15.1
- `deepseek` パッケージを削除
- `@mastra/mcp` パッケージを削除

### 2. ビルドプロセスの簡略化
✅ 実装:
- カスタム build.js でフォールバック処理
- シンプルな HTTP サーバー (server.js) の作成
- ヘルスチェックエンドポイントの実装
- エージェント情報エンドポイントの追加

### 3. React 型定義の修正
✅ 試行:
- `@types/react`: ^18 → ^18.2.0
- `@types/react-dom`: ^18 → ^18.2.0

## 根本的な問題

1. **Mastra Cloud のドキュメントと実装の不一致**
   - ドキュメントで言及されている機能が実際には利用できない
   - @mastra/cli が存在しないのに必須とされている

2. **Mastra Cloud のデプロイ要件が不明確**
   - どのような形式でサーバーを提供すべきか不明
   - エントリーポイントやビルド成果物の期待値が不明

3. **エラーメッセージが具体的でない**
   - "Readiness probe failed" だけでは問題の特定が困難
   - デバッグに必要な情報が不足

## 推奨される次のステップ

1. **Mastra サポートへの問い合わせ**
   - @mastra/cli の入手方法
   - 正しいデプロイ手順の確認
   - サンプルプロジェクトの提供依頼

2. **代替デプロイ方法の検討**
   - Vercel や Railway など、他のプラットフォームでのホスティング
   - Docker コンテナ化してのデプロイ
   - ローカルでの運用継続

3. **最小構成での再試行**
   - 依存関係を最小限に削減
   - シンプルなエージェント1つだけでテスト
   - Next.js を使わない純粋な Node.js サーバー

## 現在の状態

- ローカルでは MCP サーバーとして動作可能
- Claude Desktop との統合は成功
- Mastra Cloud へのデプロイのみが失敗
- 11個のエージェントは正常に実装済み

## 結論

Mastra Cloud は現時点でプロダクション準備が整っていない可能性があります。
公式ドキュメントと実装の間に大きなギャップがあり、必要なツール (@mastra/cli) が
提供されていません。

ローカルでの運用を継続しながら、Mastra Cloud の成熟を待つか、
代替のデプロイ方法を検討することをお勧めします。